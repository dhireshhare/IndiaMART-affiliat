<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>मेन किसान खरेदी केंद्र — IndiaMART Affiliate Products</title>
<style>
:root{
  --bg:#f7f8fa; --card:#fff; --text:#111; --muted:#6b7280; --shadow:0 10px 24px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:1100px;margin:28px auto;padding:0 14px}
.topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
.brand{font-weight:900;font-size:20px;letter-spacing:.3px}
.brand .sub{display:block;font-weight:700;font-size:12px;color:var(--muted);letter-spacing:.25px;margin-top:2px}

/* Invisible search */
.search-wrap{position:relative;width:360px;max-width:60vw}
.search{width:100%;padding:10px 12px;border-radius:9999px;border:1px solid #e5e7eb;background:#fff;box-shadow:var(--shadow);opacity:0;pointer-events:auto}
.search:focus{outline:2px solid #bfdcff;opacity:1}
.hint{font-size:12px;color:var(--muted)}

/* Grid */
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media(min-width:780px){.grid{grid-template-columns:repeat(4,minmax(0,1fr));gap:14px}}
.card{background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 6px 16px rgba(0,0,0,.09)}
.thumb{display:block;aspect-ratio:1/1;overflow:hidden;background:#eef1f4}
.thumb img{width:100%;height:100%;object-fit:cover;display:block}
.meta{padding:10px 10px 12px}
.title{font-size:13px;line-height:1.25;font-weight:800;max-height:3.2em;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical}
.price{margin-top:6px;font-weight:800;font-size:13px}
.link{display:inline-block;margin-top:8px;font-size:12px;color:#0b66e4;text-decoration:none}
.link:focus,.link:hover{text-decoration:underline}
.footer-note{margin-top:16px;font-size:12px;color:var(--muted)}
kbd{background:#111;color:#fff;border-radius:6px;padding:2px 6px;font-size:11px}
.badge{display:inline-block;font-size:11px;padding:3px 8px;border-radius:9999px;background:#eef2ff;color:#213b9a;margin-left:6px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        मेन किसान खरेदी केंद्र
        <span class="sub">IndiaMART Affiliate Products <span class="badge">CSV Driven</span></span>
      </div>
      <div class="search-wrap">
        <input id="q" class="search" type="search" placeholder="खोजें… (फोकस: /)" aria-label="खोजें">
        <div class="hint">Press <kbd>/</kbd> to search — search box stays invisible until focus.</div>
      </div>
    </div>

    <div id="grid" class="grid" role="list"></div>
    <div class="footer-note">नोट: इथे कोणताही “ad” लेबल नाही. सर्व कार्ड्स तुमच्या CSV मधील प्रोडक्ट लिंक्सवर आधारित आहेत.</div>
  </div>

<script>
/* ========= CONFIG =========
   products.csv हाच फाइल या index.html च्या शेजारी ठेवा.
   CSV हेडर: title,link,image[,price]
   IndiaMART affiliate लिंक्स link कॉलममध्ये ठेवा.
*/
const CSV_URLS = ["products.csv"];

/* ========= CSV Parser (robust for quotes/commas) ========= */
function parseCSV(text){
  const rows = [];
  let i=0, field='', row=[], inQuotes=false;
  while(i<text.length){
    const c = text[i];
    if(inQuotes){
      if(c==='\"'){
        if(text[i+1]==='\"'){ field+='\"'; i++; }
        else { inQuotes=false; }
      } else { field+=c; }
    }else{
      if(c==='\"'){ inQuotes=true; }
      else if(c===','){ row.push(field); field=''; }
      else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; }
      else if(c==='\r'){ /* ignore */ }
      else { field+=c; }
    }
    i++;
  }
  if(field.length>0 || row.length>0){ row.push(field); rows.push(row); }
  return rows;
}
function toObjects(rows){
  if(!rows.length) return [];
  const header = rows[0].map(h => (h||'').trim().toLowerCase());
  const out = [];
  for(let r=1;r<rows.length;r++){
    const obj = {};
    for(let c=0;c<header.length;c++){
      const key = header[c] || ('col'+c);
      obj[key] = (rows[r][c]||'').trim();
    }
    out.push(obj);
  }
  return out;
}
async function loadAllCSV(urls){
  let all = [];
  for(const url of urls){
    try{
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) continue;
      const txt = await res.text();
      const rows = parseCSV(txt);
      const objs = toObjects(rows);
      all = all.concat(objs);
    }catch(e){ console.warn('CSV load fail:', url, e); }
  }
  return all;
}

/* ========= Normalization ========= */
function normalizeItem(it){
  const title = it.title || it['product name'] || it.name || it['शीर्षक'] || it['नाम'] || '';
  const link  = it.link  || it.url || it.href || it['लिंक'] || it['indiamart link'] || '#';
  const image = it.image || it.img || it['image url'] || it['चित्र'] || '';
  const price = it.price || it['किंमत'] || it['क़ीमत'] || '';
  return {title, link, image, price};
}

/* ========= UI ========= */
const elGrid = document.getElementById('grid');
const elQ = document.getElementById('q');
let items = [];
let filtered = [];

function cardTemplate(item){
  const img = (item.image && item.image.startsWith('http')) ? item.image : '';
  const title = (item.title || '').toString();
  const link = (item.link || '#').toString();
  const price = (item.price || '').toString();
  const rel = "noopener nofollow sponsored"; // affiliate safe attrs
  return `
    <div class="card" role="listitem">
      <a class="thumb" href="${link}" target="_blank" rel="${rel}" aria-label="${title || 'लिंक'}">
        ${img ? `<img loading="lazy" src="${img}" alt="">` : ``}
      </a>
      <div class="meta">
        <div class="title">${title}</div>
        ${price ? `<div class="price">${price}</div>` : ``}
        <a class="link" href="${link}" target="_blank" rel="${rel}">खोलें</a>
      </div>
    </div>
  `;
}
function render(list){
  elGrid.innerHTML = list.map(cardTemplate).join('');
}

/* ========= Lazy image upgrade (optional fallback) ========= */
const io = 'IntersectionObserver' in window ? new IntersectionObserver(entries=>{
  for(const e of entries){
    if(e.isIntersecting){
      const img = e.target.querySelector('img[data-src]');
      if(img){ img.src = img.dataset.src; img.removeAttribute('data-src'); }
      io.unobserve(e.target);
    }
  }
}) : null;

/* ========= Boot ========= */
async function boot(){
  const raw = await loadAllCSV(CSV_URLS);
  items = raw.map(normalizeItem).filter(x => x.link && x.link.startsWith('http'));
  filtered = items.slice(0);
  render(filtered);
}
boot();

/* ========= Invisible Search ========= */
window.addEventListener('keydown', (e)=>{
  if(e.key === '/'){
    e.preventDefault();
    elQ.focus();
  }
});
elQ.addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  if(!q){ filtered = items.slice(0); render(filtered); return; }
  filtered = items.filter(it =>
    (it.title||'').toLowerCase().includes(q) ||
    (it.link||'').toLowerCase().includes(q) ||
    (it.price||'').toLowerCase().includes(q)
  );
  render(filtered);
});
</script>
</body>
</html>
